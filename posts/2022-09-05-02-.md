# Fetch & XMLHttpRequest API 筆記

## 無法取得/設定特殊的header值
  1. 無法設定特殊header, ex: 'referer', 'origin', ...
      * [參考MDN](https://developer.mozilla.org/zh-TW/docs/Web/API/XMLHttpRequest/setRequestHeader)
  3. 無法讀取特殊header, ex: 'etag', 'x-content-type-options'
      * [參考MDN](https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_header_name)
```javascript=
var xhr = new XMLHttpRequest(),
    method = "GET",
    url = "http://localhost:3000/public/photos/photo?&id=69639585-6a9d-43f7-90fe-97e612067b4c";

xhr.open(method, url, true);

xhr.setRequestHeader('accept', '*/*');
xhr.setRequestHeader('accept-language', 'en-US,en;q=0.9');
xhr.setRequestHeader('device', 'mobile');
xhr.setRequestHeader('if-none-match', 'W/"23-zmQd1zXjUTm4pXA62cSkCFC887Uhh"');
xhr.setRequestHeader('sec-fetch-dest', 'empty'); 
// error: Refused to set unsafe header "sec-fetch-dest"
xhr.setRequestHeader('sec-fetch-mode', 'cors'); 
// error: VM21632:12 Refused to set unsafe header "sec-fetch-mode"
xhr.setRequestHeader('sec-fetch-site', 'cors-site'); 
// error: Refused to set unsafe header "sec-fetch-site"
xhr.setRequestHeader('referer', 'http://localhost:888/');
// error: Refused to set unsafe header "referer"
xhr.setRequestHeader('qoo', 'test123');

xhr.onreadystatechange = function () {
        if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            console.log(xhr.responseText);
        }
    };
xhr.send();


xhr.getResponseHeader('etag'); 
// error: VM21640:1 Refused to get unsafe header "etag"
xhr.getResponseHeader('x-content-type-options');
// error: Refused to get unsafe header "x-content-type-options"
xhr.getResponseHeader('content-type'); 
// 'application/json; charset=utf-8'
xhr.getResponseHeader('contenT-typE'); // (不分大小寫)
// 'application/json; charset=utf-8'

//------------- fecth api 行為同 XMLHttpReuqest 但console不會有紅色錯誤提示
fetch("http://localhost:3000/public/photos/photo?&id=69639585-6a9d-43f7-90fe-97e612067b4c", {
  "headers": {
    "accept": "*/*",
    "accept-language": "en-US,en;q=0.9",
    "device": "mobile",
    "if-none-match": "W/\"23-zmQd1zXjUTm4pXA62cSkCFC887Uhh\"",
    "sec-fetch-dest": "empty", // 會被遊覽器濾掉且不會有錯誤提示
    "sec-fetch-mode": "cors",  // 會被遊覽器濾掉且不會有錯誤提示
    "sec-fetch-site": "cross-site" // 會被遊覽器濾掉且不會有錯誤提示
  },
  "referrer": "http://localhost:888/", // 會被遊覽器濾掉且不會有錯誤提示
  "referrerPolicy": "strict-origin-when-cross-origin",
  "body": null,
  "method": "GET",
  "mode": "cors",
  "credentials": "omit"
}).then(res => {
 console.log('res', res);
    const clonedResponse = res.clone(); // 複製一份response
    console.log('same??', clonedResponse === res); // false
}, err => console.log('err', err));
```

## fetch response.toBlob() diff response.toText()
[blob()](https://developer.mozilla.org/en-US/docs/Web/API/Response/blob): 對於返回的資料不做編碼處理,通常當作資料流.  

[arrayBuffer()](https://developer.mozilla.org/en-US/docs/Web/API/Response/arrayBuffer): 對於返回的資料不做編碼處理,通常當作資料流.  

[text()](https://developer.mozilla.org/en-US/docs/Web/API/Response/text): 對於返回的資料會做utf-8處理,也就是會將資料流每4bytes組成一個字符並使用utf-8編碼.

